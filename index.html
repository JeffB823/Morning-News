<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Morning News ‚Äî Neo (Fahrenheit)</title>
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#0b1220">
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
  <link rel="preconnect" href="https://api.allorigins.win" crossorigin>
  <link rel="preconnect" href="https://geocoding-api.open-meteo.com" crossorigin>
  <link rel="preconnect" href="https://api.open-meteo.com" crossorigin>
  <link rel="preconnect" href="https://ip-api.open-meteo.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* (Same Neo design system styles as previous version) */
    :root {
      --bg: #0a0f1e; --bg-grid: rgba(255,255,255,0.04);
      --surface: rgba(255,255,255,0.06); --surface-2: rgba(255,255,255,0.04);
      --text: #e6e9ef; --muted: #9aa4b2; --accent: #7dd3fc; --accent-2: #a78bfa;
      --accent-soft: rgba(167,139,250,.25); --ring: rgba(125,211,252,.45);
      --divider: rgba(255,255,255,.08); --shadow: 0 10px 30px rgba(2,6,23,.35);
      --radius: 18px; --row-min-height: 90px;
    }
    :root:not(.dark) {
      --bg: #f6f7fb; --bg-grid: rgba(3,7,18,0.05);
      --surface: rgba(255,255,255,0.85); --surface-2: rgba(255,255,255,0.70);
      --text: #0b1020; --muted: #5b6575; --accent: #2563eb; --accent-2: #06b6d4;
      --accent-soft: rgba(2,132,199,.18); --ring: rgba(37,99,235,.35);
      --divider: rgba(3,7,18,.08); --shadow: 0 10px 28px rgba(2,6,23,.12);
    }
    body {
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 100% -10%, rgba(167,139,250,.08), transparent 60%),
        radial-gradient(900px 500px at -10% 110%, rgba(125,211,252,.08), transparent 55%),
        var(--bg);
      position: relative; min-height: 100vh;
    }
    body::before {
      content: ""; position: fixed; inset: 0; pointer-events: none;
      background-image:
        linear-gradient(var(--bg-grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
      background-size: 24px 24px;
      mask-image: radial-gradient(1200px 600px at 50% -10%, rgba(0,0,0,.9), rgba(0,0,0,.2) 60%, transparent 70%);
    }
    .glass { background: var(--surface); backdrop-filter: blur(12px); border: 1px solid var(--divider); box-shadow: var(--shadow); }
    .card { background: var(--surface); border: 1px solid var(--divider); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card-2 { background: var(--surface-2); border: 1px solid var(--divider); border-radius: var(--radius); box-shadow: var(--shadow); }
    .btn-ghost { border: 1px solid var(--divider); background: transparent; border-radius: 12px; padding: 6px 10px; }
    .btn-ghost:hover { background: rgba(255,255,255,.06); }
    .chip {
      position: relative; border-radius: 9999px; padding: 8px 14px; border: 1px solid transparent;
      background: linear-gradient(var(--surface), var(--surface)) padding-box,
                  linear-gradient(135deg, var(--accent), var(--accent-2)) border-box; color: var(--text);
    }
    .chip.active {
      background: linear-gradient(135deg, rgba(125,211,252,.18), rgba(167,139,250,.18)) padding-box,
                  linear-gradient(135deg, var(--accent), var(--accent-2)) border-box;
      box-shadow: 0 0 0 1px var(--accent-soft) inset, 0 0 24px var(--accent-soft);
    }
    .brand { background: linear-gradient(135deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .kbd { padding: 2px 6px; border-radius: 6px; border: 1px solid var(--divider); font-size: 12px; color: var(--muted); }
    .divider { border-color: var(--divider) !important; }
    .news-row { content-visibility: auto; contain-intrinsic-size: var(--row-min-height) 1000px; }
    .blur-up { filter: blur(10px); transition: filter .4s ease; } .blur-up.loaded { filter: blur(0); }
    .ticker-fallback { white-space: nowrap; overflow: hidden; mask-image: linear-gradient(90deg, transparent, #000 10%, #000 90%, transparent); }
    .ticker-fallback-inner { display: inline-block; padding-left: 100%; animation: ticker 22s linear infinite; opacity: .9; }
    @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .no-motion * { animation: none !important; transition: none !important; }
    .skeleton { position: relative; overflow: hidden; }
    .skeleton::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(125,211,252,.18), transparent); transform: translateX(-100%); animation: shimmer 1.15s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
    dialog { background: var(--surface); border: 1px solid var(--divider); color: var(--text); border-radius: var(--radius); }
    .muted { color: var(--muted); }
    .input { background: var(--surface-2); border: 1px solid var(--divider); color: var(--text); border-radius: 12px; padding: 10px 12px; outline: none; }
    .input:focus { box-shadow: 0 0 0 3px var(--ring); border-color: transparent; }
  </style>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Helvetica','Arial'] } } } };
  </script>
</head>
<body class="h-full selection:bg-cyan-400/25">
  <div id="offlineBanner" class="text-center text-sm py-1 px-3 card-2 mx-auto max-w-6xl mt-2 hidden">Offline ‚Äî showing cached headlines</div>

  <header class="sticky top-0 z-30 glass">
    <div class="mx-auto max-w-6xl px-4 py-3 flex flex-wrap items-center gap-3">
      <div class="text-xl font-semibold tracking-tight"><span class="brand">Morning News</span></div>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <label class="inline-flex items-center gap-2 cursor-pointer"><span class="hidden sm:inline muted">Density</span>
          <select id="densitySelect" class="input text-sm"><option value="comfy">Comfy</option><option value="compact">Compact</option></select>
        </label>
        <label class="inline-flex items-center gap-2 cursor-pointer"><span class="hidden sm:inline muted">Private</span><input id="privateToggle" type="checkbox" class="accent-cyan-400"></label>
        <button id="themeToggle" class="btn-ghost" title="Toggle theme (t)">üåì</button>
      </div>
      <div class="w-full sm:w-auto sm:ml-4 flex-1">
        <div class="relative">
          <input id="search" type="search" placeholder="Search headlines (/)" class="w-full sm:w-96 input">
          <div class="absolute right-2 top-1/2 -translate-y-1/2 text-xs muted"><span class="kbd">/</span></div>
        </div>
      </div>
    </div>
    <div class="border-t divider">
      <div class="mx-auto max-w-6xl">
        <div id="tvContainer" class="relative">
          <div id="tickerFallback" class="ticker-fallback px-4 py-2 text-sm">
            <div class="ticker-fallback-inner"><span class="brand">S&amp;P 500 ¬∑ Dow ¬∑ Nasdaq ¬∑ FTSE 100 ¬∑ DAX ¬∑ Nikkei 225 ¬∑ Crude Oil ¬∑ Gold ¬∑ BTC/USD</span></div>
          </div>
          <div id="tradingview-widget" class="hidden"></div>
        </div>
      </div>
    </div>
  </header>

  <section class="mx-auto max-w-6xl px-4 mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Weather</div>
        <div class="text-xs flex items-center gap-3 muted">
          <button id="setCityBtn" class="underline">Set City</button>
          <button id="refreshWeatherBtn" class="underline">Refresh</button>
        </div>
      </div>
      <div id="weather" class="mt-2 text-sm muted">Loading weather‚Ä¶</div>
    </div>
    <div class="card col-span-1 md:col-span-2 p-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Inspiration</div>
        <div class="text-xs muted">Why this: <span id="quoteWhy">focus</span></div>
      </div>
      <figure class="mt-2">
        <blockquote id="quoteText" class="text-lg leading-relaxed"></blockquote>
        <figcaption id="quoteBy" class="mt-2 text-sm muted"></figcaption>
      </figure>
    </div>
  </section>

  <nav class="mx-auto max-w-6xl px-4 mt-4">
    <div id="chips" class="flex flex-wrap gap-2 text-sm"></div>
    <div class="mt-2 text-xs muted flex items-center gap-2">
      <button id="pinBtn" class="btn-ghost">üìå Pin this section</button>
      <span>Shortcuts: <span class="kbd">1‚Äì6</span>, <span class="kbd">r</span> refresh</span>
    </div>
  </nav>

  <main class="mx-auto max-w-6xl px-4 mt-4">
    <div id="status" class="text-sm muted"></div>
    <ul id="newsList" class="mt-3 space-y-2"></ul>
  </main>

  <footer class="sticky bottom-0 z-20 mt-10 glass">
    <div class="mx-auto max-w-6xl px-4 py-2 text-xs muted flex items-center justify-between">
      <div>‚å®Ô∏è <span class="kbd">/</span> search ¬∑ <span class="kbd">t</span> theme ¬∑ <span class="kbd">r</span> refresh ¬∑ <span class="kbd">1‚Äì6</span> sections</div>
      <div><a class="underline" href="#" id="aboutLink">About</a></div>
    </div>
  </footer>

  <dialog id="reader" class="w-full max-w-3xl p-0">
    <form method="dialog">
      <div class="flex items-center justify-between px-4 py-3 border-b divider">
        <div class="font-semibold" id="readerTitle">Reader</div>
        <div class="flex items-center gap-2 text-sm">
          <label class="inline-flex items-center gap-2">A<sup>-</sup><input id="fontDown" type="button" class="btn-ghost" value="-"></label>
          <label class="inline-flex items-center gap-2">A<sup>+</sup><input id="fontUp" type="button" class="btn-ghost" value="+"></label>
          <label class="inline-flex items-center gap-2">LH<input id="lhUp" type="button" class="btn-ghost" value="+"></label>
          <button id="readerSpeak" type="button" class="btn-ghost">üîä Listen</button>
          <button id="readerClose" class="btn-ghost">‚úï</button>
        </div>
      </div>
    </form>
    <div id="readerBody" class="p-4 leading-relaxed"></div>
    <div class="p-4 pt-0 text-right text-xs muted"><a class="underline" id="readerOpen" target="_blank" rel="noopener">Open original</a></div>
  </dialog>

  <dialog id="about" class="w-full max-w-lg p-0">
    <form method="dialog">
      <div class="flex items-center justify-between px-4 py-3 border-b divider">
        <div class="font-semibold">About this page</div>
        <button class="btn-ghost">‚úï</button>
      </div>
    </form>
    <div class="p-4 text-sm space-y-2">
      <p>This is a free, single-file morning dashboard. It uses public RSS feeds via AllOrigins, article text via Jina reader, and weather via Open‚ÄëMeteo. A Service Worker caches the shell and last good data for offline reading.</p>
      <ul class="list-disc pl-5 muted">
        <li>Shortcuts: <span class="kbd">/</span> search, <span class="kbd">t</span> theme, <span class="kbd">r</span> refresh, <span class="kbd">1‚Äì6</span> section jump</li>
        <li>Density toggle and reader font/line-height persist</li>
        <li>Private Mode disables IP lookup; set your city manually</li>
      </ul>
    </div>
  </dialog>

  <script>
  const $ = sel => document.querySelector(sel);
  const LS = {
    get: (k, d=null) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } },
    set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
    del: (k) => { try { localStorage.removeItem(k); } catch {} }
  };

  const STATE = {
    sectionOrder: ["Top","National","Ohio","Columbus","Home Lending","AI"],
    currentSection: "Top",
    pinnedSection: LS.get('pinnedSection','Top'),
    density: LS.get('density','comfy'),
    privateMode: LS.get('privateMode', false),
    fontScale: LS.get('readerFontScale', 1.0),
    lineHeight: LS.get('readerLineHeight', 1.6),
    city: LS.get('city', ""),
    coords: LS.get('coords', null),
    prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
  };
  if (STATE.prefersReducedMotion) document.documentElement.classList.add('no-motion');

  const FEEDS = {
    "Top": ["https://feeds.reuters.com/reuters/topNews","https://feeds.npr.org/1001/rss.xml"],
    "National": ["https://feeds.npr.org/1003/rss.xml","https://rss.nytimes.com/services/xml/rss/nyt/US.xml"],
    "Ohio": ["https://www.cleveland.com/arc/outboundfeeds/rss/?outputType=xml","https://www.dispatch.com/feeds/news?x=1"],
    "Columbus": ["https://www.columbusunderground.com/rss/","https://radio.wosu.org/rss.xml"],
    "Home Lending": ["https://www.mortgagenewsdaily.com/rss","https://newslink.mba.org/feed/","https://www.housingwire.com/rss"],
    "AI": ["https://openai.com/blog/rss","https://venturebeat.com/category/ai/feed/","https://www.theverge.com/artificial-intelligence/rss/index.xml"]
  };
  const TTL_MIN = 12, FEED_TIMEOUT = 12000;

  const QUOTES = [
    { text: "You do not rise to the level of your goals. You fall to the level of your systems.", by: "James Clear", why: "consistency" },
    { text: "Focus is saying no.", by: "Steve Jobs", why: "focus" },
    { text: "What you do every day matters more than what you do once in a while.", by: "Gretchen Rubin", why: "habits" },
    { text: "If it costs you your peace, it's too expensive.", by: "Unknown", why: "clarity" },
    { text: "The man who moves a mountain begins by carrying away small stones.", by: "Confucius", why: "momentum" }
  ];

  function applyDensity() {
    const list = $("#newsList");
    if (!list) return;
    if (STATE.density === "compact") { list.classList.add("divide-y","divide-white/5"); list.classList.remove("space-y-2"); }
    else { list.classList.add("space-y-2"); list.classList.remove("divide-y","divide-white/5"); }
    $("#densitySelect").value = STATE.density; LS.set('density', STATE.density);
  }
  function setTheme(t) {
    const root = document.documentElement;
    if (t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) root.classList.add('dark');
    else root.classList.remove('dark');
    LS.set('theme', t || 'system');
  }
  function setupShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== $("#search")) { e.preventDefault(); $("#search").focus(); return; }
      if (e.key.toLowerCase() === 't') { e.preventDefault(); $("#themeToggle").click(); }
      if (e.key.toLowerCase() === 'r') { e.preventDefault(); refreshCurrentSection(); }
      if (/^[1-6]$/.test(e.key)) { const idx = Number(e.key) - 1; const name = STATE.sectionOrder[idx]; if (name) selectSection(name); }
    });
  }
  function loadTradingView() {
    const container = document.getElementById('tradingview-widget');
    container.classList.remove('hidden');
    const script = document.createElement('script');
    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js";
    script.async = true;
    script.text = JSON.stringify({
      "symbols": [
        {"proName": "FOREXCOM:SPXUSD", "title": "S&P 500"}, {"proName": "DJI", "title": "Dow"},
        {"proName": "NASDAQ:IXIC", "title": "Nasdaq"}, {"proName": "CAPITALCOM:UK100", "title": "FTSE 100"},
        {"proName": "XETR:DAX", "title": "DAX"}, {"proName": "TVC:NI225", "title": "Nikkei 225"},
        {"proName": "TVC:USOIL", "title": "Crude Oil"}, {"proName": "TVC:GOLD", "title": "Gold"},
        {"proName": "BITSTAMP:BTCUSD", "title": "BTC/USD"}
      ],
      "showSymbolLogo": true, "isTransparent": true,
      "colorTheme": document.documentElement.classList.contains('dark') ? "dark" : "light",
      "displayMode": "adaptive", "locale": "en"
    });
    document.getElementById('tvContainer').appendChild(script);
    setTimeout(() => { const has = document.querySelector('#tradingview-widget iframe, #tradingview-widget div'); if (has) $("#tickerFallback").style.display = 'none'; }, 3000);
  }

  // ========== WEATHER (Fahrenheit + 12-hour times) ==========
  async function geocodeCity(name) {
    const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
    const gj = await g.json();
    if (gj?.results?.length) { const r = gj.results[0]; return { lat: r.latitude, lon: r.longitude, display: r.name + (r.admin1 ? ", " + r.admin1 : "") }; }
    return null;
  }
  async function reverseGeocode(lat, lon) {
    const g = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en&format=json`);
    const gj = await g.json();
    if (gj?.results?.length) { const r = gj.results[0]; return r.name + (r.admin1 ? ", "+r.admin1 : ""); }
    return "";
  }
  async function resolveWeatherLocation() {
    if (STATE.privateMode) {
      if (STATE.city) { const geo = await geocodeCity(STATE.city); if (geo) return { lat: geo.lat, lon: geo.lon, city: geo.display }; }
      return null;
    }
    if (STATE.city) { const geo = await geocodeCity(STATE.city); if (geo) return { lat: geo.lat, lon: geo.lon, city: geo.display }; }
    try {
      const ip = await fetch('https://ip-api.open-meteo.com/v1/ip?timezone=auto', { cache: 'no-store' });
      if (ip.ok) { const j = await ip.json(); const city = j.city || j.timezone || ""; return { lat: j.latitude, lon: j.longitude, city }; }
    } catch {}
    try {
      const coords = await new Promise((res, rej) => {
        if (!navigator.geolocation) return rej(new Error('no geo'));
        navigator.geolocation.getCurrentPosition(pos => res(pos.coords), err => rej(err), { maximumAge: 600000, timeout: 6000 });
      });
      const city = await reverseGeocode(coords.latitude, coords.longitude);
      return { lat: coords.latitude, lon: coords.longitude, city: city || "" };
    } catch {}
    return null;
  }
  function fmt12(tstr) {
    if (!tstr) return '--:--';
    // Open‚ÄëMeteo returns local times without timezone suffix when timezone=auto‚Äîthis will be treated as local by JS.
    const d = new Date(tstr);
    return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }
  async function loadWeather() {
    const el = $("#weather"); el.textContent = 'Loading weather‚Ä¶';
    try {
      const info = await resolveWeatherLocation();
      if (!info) { el.textContent = 'Set your city to show weather.'; return; }
      STATE.city = info.city || STATE.city || ''; LS.set('city', STATE.city); LS.set('coords', { lat: info.lat, lon: info.lon });
      const wx = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${info.lat}&longitude=${info.lon}&current=temperature_2m,apparent_temperature,wind_speed_10m,weather_code&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto&temperature_unit=fahrenheit&wind_speed_unit=mph`);
      const w = await wx.json();
      const cityLabel = STATE.city || 'Your city';
      const t = Math.round(w.current.temperature_2m);
      const hi = Math.round(w.daily.temperature_2m_max[0]);
      const lo = Math.round(w.daily.temperature_2m_min[0]);
      const sr = fmt12(w.daily.sunrise[0]);
      const ss = fmt12(w.daily.sunset[0]);
      el.innerHTML = `
        <div class="text-sm"><span class="font-semibold">${cityLabel}</span></div>
        <div class="mt-2 flex items-center gap-4">
          <div class="text-3xl font-bold" style="background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent;">${t}¬∞F</div>
          <div class="text-sm muted">H: ${hi}¬∞F ¬∑ L: ${lo}¬∞F</div>
        </div>
        <div class="mt-2 text-xs muted">Sunrise ${sr} ¬∑ Sunset ${ss}</div>
      `;
    } catch (e) { el.innerHTML = '<div class="text-rose-400">Weather unavailable.</div>'; }
  }
  document.getElementById('setCityBtn').addEventListener('click', async () => {
    const c = prompt('Enter city (e.g., Columbus):', STATE.city || '');
    if (c !== null) { STATE.city = c.trim(); STATE.coords = null; LS.set('city', STATE.city); LS.del('coords'); loadWeather(); }
  });
  document.getElementById('refreshWeatherBtn').addEventListener('click', loadWeather);

  // ===== Quotes =====
  function loadQuote() { const q = QUOTES[Math.floor(Math.random()*QUOTES.length)]; document.getElementById('quoteText').textContent = `‚Äú${q.text}‚Äù`; document.getElementById('quoteBy').textContent = `‚Äî ${q.by}`; document.getElementById('quoteWhy').textContent = q.why; }

  // ===== Chips / Sections / News (unchanged aside from visuals) =====
  function renderChips() {
    const chips = document.getElementById('chips'); chips.innerHTML = '';
    STATE.sectionOrder.forEach((s) => {
      const btn = document.createElement('button');
      btn.className = "chip " + (STATE.currentSection === s ? "active" : ""); btn.textContent = s; btn.onclick = () => selectSection(s);
      chips.appendChild(btn);
    });
  }
  document.getElementById('pinBtn').addEventListener('click', () => { STATE.pinnedSection = STATE.currentSection; LS.set('pinnedSection', STATE.pinnedSection); const st = document.getElementById('status'); st.textContent = `Pinned: ${STATE.pinnedSection}`; setTimeout(()=> st.textContent = '', 1500); });

  function proxy(url) { return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`; }
  function cacheKey(section) { return `feed.${section}`; }
  function cacheTimeKey(section) { return `feed.${section}.ts`; }
  function parseRSS(xmlText) {
    const doc = new DOMParser().parseFromString(xmlText, "application/xml");
    let items = [...doc.querySelectorAll('item')].map(it => ({
      title: it.querySelector('title')?.textContent?.trim() || 'Untitled',
      link: it.querySelector('link')?.textContent?.trim(),
      pubDate: it.querySelector('pubDate')?.textContent || it.querySelector('updated')?.textContent || '',
      description: it.querySelector('description')?.textContent || '',
      media: it.querySelector('media\\:content, content, enclosure')?.getAttribute('url') || ''
    }));
    if (items.length === 0) {
      items = [...doc.querySelectorAll('entry')].map(en => ({
        title: en.querySelector('title')?.textContent?.trim() || 'Untitled',
        link: en.querySelector('link')?.getAttribute('href'),
        pubDate: en.querySelector('updated')?.textContent || en.querySelector('published')?.textContent || '',
        description: en.querySelector('summary')?.textContent || '',
        media: en.querySelector('link[rel="enclosure"]')?.getAttribute('href') || ''
      }));
    }
    return items;
  }
  function faviconFor(url) { try { return `https://www.google.com/s2/favicons?sz=64&domain=${(new URL(url)).hostname}`; } catch { return ''; } }
  function mergeDedup(a, b) { const map = new Map(); [...a, ...b].forEach(it => { if (it && it.link) map.set(it.link, it); }); return Array.from(map.values()).sort((x,y)=> (y.time||0)-(x.time||0)).slice(0, 60); }
  function showSkeletons(n=6) {
    const list = document.getElementById('newsList'); list.innerHTML = '';
    for (let i=0;i<n;i++) {
      const li = document.createElement('li');
      li.className = "news-row card-2 p-3 skeleton"; li.style.minHeight = '84px';
      li.innerHTML = `<div class="h-5 w-28 rounded mb-2" style="background:var(--surface);"></div>
                      <div class="h-4 w-5/6 rounded mb-1" style="background:var(--surface);"></div>
                      <div class="h-4 w-4/6 rounded" style="background:var(--surface);"></div>`;
      list.appendChild(li);
    }
  }
  function renderItems(items) {
    const list = document.getElementById('newsList');
    const q = document.getElementById('search').value.toLowerCase().trim();
    const filtered = q ? items.filter(x => ((x.title||'')+' '+(x.description||'')).toLowerCase().includes(q)) : items;
    list.innerHTML = '';
    for (const it of filtered) {
      const li = document.createElement('li');
      li.className = "news-row card hover:shadow-xl transition";
      li.innerHTML = `
        <a href="${it.link}" target="_blank" rel="noopener" class="block p-3">
          <div class="flex gap-3">
            <div class="w-14 h-14 rounded-lg overflow-hidden" style="background:var(--surface-2);">
              <img class="w-full h-full object-cover blur-up" loading="lazy" alt="thumbnail"
                 src="${it.media || faviconFor(it.link)}"
                 onload="this.classList.add('loaded')"
                 onerror="this.src='${faviconFor(it.link)}'; this.classList.add('loaded')">
            </div>
            <div class="min-w-0 flex-1">
              <div class="text-sm muted truncate">${it.source || (new URL(it.link)).hostname.replace(/^www\./,'')}</div>
              <div class="font-medium leading-snug">${it.title}</div>
              <div class="text-xs muted mt-1 line-clamp-2">${(it.description || '').replace(/<[^>]+>/g,'').slice(0,160)}‚Ä¶</div>
              <div class="flex items-center gap-3 mt-2 text-xs muted">
                <button class="underline listen" data-title="${(it.title || '').replace(/"/g,'&quot;')}" data-link="${it.link}">üîä Listen</button>
                <button class="underline read" data-link="${it.link}" data-title="${(it.title || '').replace(/"/g,'&quot;')}">üì∞ Read</button>
                <span>${new Date(it.time||Date.now()).toLocaleString()}</span>
              </div>
            </div>
          </div>
        </a>
      `;
      list.appendChild(li);
    }
    list.querySelectorAll('button.listen').forEach(b => b.addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      const t = b.getAttribute('data-title');
      speakText(`${t}.`);
    }));
    list.querySelectorAll('button.read').forEach(b => b.addEventListener('click', async (e) => {
      e.preventDefault(); e.stopPropagation();
      const link = b.getAttribute('data-link');
      const title = b.getAttribute('data-title');
      openReader(title, link);
    }));
  }
  let aborter = null;
  async function fetchFeed(url) {
    const ctrl = new AbortController(); const to = setTimeout(() => ctrl.abort(), FEED_TIMEOUT);
    try {
      const r = await fetch(proxy(url), { signal: ctrl.signal });
      const txt = await r.text();
      return parseRSS(txt).map(x => ({ ...x, source: (new URL(x.link)).hostname.replace(/^www\./,''), time: x.pubDate ? new Date(x.pubDate).getTime() : Date.now() }));
    } finally { clearTimeout(to); }
  }
  async function loadSection(section) {
    STATE.currentSection = section; renderChips();
    document.getElementById('status').textContent = 'Loading‚Ä¶'; showSkeletons(6);
    if (aborter) aborter.abort(); aborter = new AbortController();

    const ts = LS.get(cacheTimeKey(section), 0);
    const ageMin = (Date.now() - ts) / 60000;
    if (ageMin < TTL_MIN) {
      const cached = LS.get(cacheKey(section), []);
      if (cached.length) { renderItems(cached); document.getElementById('status').textContent = `Loaded from cache (${Math.round(ageMin)}m old).`; }
    }

    try {
      const urls = FEEDS[section] || [];
      let items = [];
      if (urls[0]) {
        try {
          const first = await fetchFeed(urls[0]);
          items = mergeDedup(items, first);
          renderItems(items);
          document.getElementById('status').textContent = `Updated from ${new URL(urls[0]).hostname}`;
        } catch {}
      }
      const rest = urls.slice(1).map(u => fetchFeed(u).catch(()=>[]));
      const batches = await Promise.all(rest);
      for (const b of batches) items = mergeDedup(items, b);
      if (items.length) {
        renderItems(items);
        document.getElementById('status').textContent = `Updated ${new Date().toLocaleTimeString()}`;
        LS.set(cacheKey(section), items); LS.set(cacheTimeKey(section), Date.now());
      } else { document.getElementById('status').textContent = 'No items from feeds.'; }
    } catch (e) {
      document.getElementById('offlineBanner').classList.remove('hidden');
      document.getElementById('status').textContent = 'Network issue ‚Äî showing last good headlines if available.';
      const cached = LS.get(cacheKey(section), []); if (cached.length) renderItems(cached);
    }
  }

  // TTS + Reader
  let speechUtter = null;
  function speakText(text) { if (!('speechSynthesis' in window)) { alert('TTS not supported in this browser.'); return; } if (speechUtter) { window.speechSynthesis.cancel(); speechUtter = null; } speechUtter = new SpeechSynthesisUtterance(text); speechUtter.rate = 1.0; speechUtter.pitch = 1.0; window.speechSynthesis.speak(speechUtter); }
  async function openReader(title, url) {
    document.getElementById('readerTitle').textContent = title;
    document.getElementById('readerBody').innerHTML = '<div class="muted p-4">Loading article‚Ä¶</div>';
    document.getElementById('readerOpen').href = url;
    try {
      const inner = url.startsWith('https://') ? 'https://' : 'http://';
      const target = 'https://r.jina.ai/' + inner + url.replace(/^https?:\/\//,'');
      const res = await fetch(target); const txt = await res.text();
      const safe = txt.replace(/[<>]/g, m => ({'<':'&lt;','>':'&gt;'}[m]));
      document.getElementById('readerBody').style.fontSize = (STATE.fontScale*1.0)+'rem';
      document.getElementById('readerBody').style.lineHeight = STATE.lineHeight;
      document.getElementById('readerBody').innerHTML = '<pre class="whitespace-pre-wrap">'+safe+'</pre>';
    } catch { document.getElementById('readerBody').innerHTML = '<div class="text-rose-400 p-4">Could not load article.</div>'; }
    document.getElementById('reader').showModal();
  }
  document.getElementById('readerClose').addEventListener('click', () => { document.getElementById('reader').close(); });
  document.getElementById('readerSpeak').addEventListener('click', () => { const t = document.getElementById('readerTitle').textContent || ''; const body = document.getElementById('readerBody').innerText || ''; speakText(`${t}. ${body.slice(0, 1200)}`); });
  document.getElementById('fontUp').addEventListener('click', () => { STATE.fontScale = Math.min(STATE.fontScale + 0.1, 1.6); document.getElementById('readerBody').style.fontSize = (STATE.fontScale*1.0)+'rem'; LS.set('readerFontScale', STATE.fontScale); });
  document.getElementById('fontDown').addEventListener('click', () => { STATE.fontScale = Math.max(STATE.fontScale - 0.1, 0.8); document.getElementById('readerBody').style.fontSize = (STATE.fontScale*1.0)+'rem'; LS.set('readerFontScale', STATE.fontScale); });
  document.getElementById('lhUp').addEventListener('click', () => { STATE.lineHeight = Math.min(STATE.lineHeight + 0.1, 2.0); document.getElementById('readerBody').style.lineHeight = STATE.lineHeight; LS.set('readerLineHeight', STATE.lineHeight); });

  // Search / Sections / Toggles / Connectivity / SW
  document.getElementById('search').addEventListener('input', () => { const items = LS.get(cacheKey(STATE.currentSection), []); if (items.length) renderItems(items); });
  function selectSection(s) { STATE.currentSection = s; LS.set('lastSection', s); renderChips(); loadSection(s); }
  function refreshCurrentSection() { LS.del(cacheKey(STATE.currentSection)); LS.del(cacheTimeKey(STATE.currentSection)); loadSection(STATE.currentSection); }
  document.getElementById('densitySelect').addEventListener('change', (e) => { STATE.density = e.target.value; applyDensity(); });
  document.getElementById('privateToggle').checked = !!STATE.privateMode;
  document.getElementById('privateToggle').addEventListener('change', (e) => { STATE.privateMode = e.target.checked; LS.set('privateMode', STATE.privateMode); if (STATE.privateMode) document.getElementById('weather').textContent = 'Private mode enabled ‚Äî set your city.'; else loadWeather(); });
  document.getElementById('themeToggle').addEventListener('click', () => { const dark = !document.documentElement.classList.contains('dark'); setTheme(dark ? 'dark' : 'light'); document.getElementById('tradingview-widget').innerHTML = ''; loadTradingView(); });
  function updateOfflineUI() { if (!navigator.onLine) document.getElementById('offlineBanner').classList.remove('hidden'); else document.getElementById('offlineBanner').classList.add('hidden'); }
  window.addEventListener('online', updateOfflineUI); window.addEventListener('offline', updateOfflineUI);
  async function registerSW() {
    if (!('serviceWorker' in navigator)) return; if (location.protocol === 'file:') return;
    const swCode = `
      const CACHE = 'morning-news-neo-f';
      self.addEventListener('install', e => { e.waitUntil(caches.open(CACHE).then(c => c.addAll(['./']))); });
      self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', e => {
        const url = new URL(e.request.url);
        if (url.origin === location.origin) { e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))); }
        else if (/allorigins|open-meteo|jina\\.ai/.test(url.hostname)) {
          e.respondWith((async () => { try { const res = await fetch(e.request); const c = await caches.open(CACHE); c.put(e.request, res.clone()); return res; } catch (err) { const cached = await caches.match(e.request); if (cached) return cached; throw err; } })());
        }
      });
    `;
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    try { await navigator.serviceWorker.register(url, {scope: './'}); } catch {}
  }

  (async function init(){
    const savedTheme = LS.get('theme','system'); setTheme(savedTheme);
    loadTradingView(); loadQuote();
    STATE.currentSection = LS.get('lastSection', STATE.pinnedSection || 'Top'); renderChips(); applyDensity();
    updateOfflineUI(); registerSW(); loadWeather(); loadSection(STATE.currentSection);
    document.addEventListener('keydown', (e) => { if (e.key === 'r' && !/input|textarea/i.test((document.activeElement||{}).tagName||'')) { e.preventDefault(); refreshCurrentSection(); } });
    setupShortcuts();
  })();

  document.getElementById('aboutLink').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('about').showModal(); });
  </script>
</body>
</html>
