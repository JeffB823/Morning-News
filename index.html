<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Morning News ‚Äî Ultra Mobile</title>
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Helvetica','Arial'] },
          boxShadow: {
            subtle: '0 4px 16px rgba(2,6,23,.06), 0 1px 4px rgba(2,6,23,.05)',
            card: '0 8px 28px rgba(2,6,23,.08), 0 2px 8px rgba(2,6,23,.06)'
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --radius: 16px; --tintA: rgba(99, 102, 241, 0.08); --tintB: rgba(14, 165, 233, 0.08); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-5 { display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; }
    .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 14px; background: #e2e8f0; }
    @media (prefers-color-scheme: dark) { .thumb { background: #0b1220; } }
    .glass { backdrop-filter: saturate(140%) blur(8px); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }
    .safe-top { padding-top: calc(env(safe-area-inset-top) + 8px); }
    body.bg-dynamic { transition: background 600ms cubic-bezier(.2,.8,.2,1); background-attachment: fixed; }
    .card-tint { background-image: linear-gradient(180deg, var(--tintA), var(--tintB)); }
    .chip { white-space: nowrap; }
  </style>
</head>
<body class="h-full bg-dynamic text-slate-900 dark:text-slate-100">
  <!-- Sticky top app bar -->
  <header class="sticky top-0 z-50 glass bg-white/85 dark:bg-slate-950/75 border-b border-slate-200 dark:border-slate-800 safe-top">
    <div class="max-w-screen-sm mx-auto px-3 pt-2 pb-2 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0">
        <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-indigo-500 to-sky-500 shadow-subtle" aria-hidden="true"></div>
        <div class="min-w-0">
          <h1 class="text-base font-extrabold tracking-tight leading-tight truncate">Morning News</h1>
          <p class="text-[11px] text-slate-500 dark:text-slate-400 leading-tight truncate">Fast, focused updates</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeBtn" class="px-2.5 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Theme</button>
        <button id="refreshBtn" class="px-2.5 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Refresh</button>
      </div>
    </div>

    <!-- Search + Mode -->
    <div class="max-w-screen-sm mx-auto px-3 pb-2 flex items-stretch gap-2">
      <input id="filterBox" type="search" placeholder="Search headlines‚Ä¶" class="flex-1 px-3 py-2 text-sm rounded-xl border border-slate-300 dark:border-slate-700 bg-white/90 dark:bg-slate-900/70 outline-none">
      <button id="locBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-xs">üìç</button>
      <select id="modeSel" class="px-2 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-xs">
        <option value="headlines">Headlines</option>
        <option value="summaries" selected>Summaries</option>
        <option value="reader">Reader</option>
      </select>
    </div>

    <!-- Category chips (intuitive top navigation) -->
    <div class="max-w-screen-sm mx-auto px-3 pb-2 overflow-x-auto no-scrollbar">
      <div id="chips" class="flex gap-2"></div>
    </div>

    <!-- Weather card -->
    <div class="max-w-screen-sm mx-auto px-3 pb-3 space-y-2">
      <div id="wxCard" class="hidden rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/70 p-3 text-sm flex items-center justify-between">
        <div class="min-w-0">
          <div id="wxPlace" class="font-semibold truncate">‚Äî</div>
          <div id="wxDesc" class="text-xs text-slate-600 dark:text-slate-400 truncate">‚Äî</div>
        </div>
        <div class="text-right">
          <div id="wxTemp" class="text-lg font-bold">‚Äî¬∞F</div>
          <div id="wxMeta" class="text-[11px] text-slate-500 dark:text-slate-400">‚Äî</div>
        </div>
      </div>
      <div id="wxStrip" class="hidden rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/70 p-2 overflow-x-auto no-scrollbar">
        <div id="wxRow" class="flex gap-2"></div>
      </div>
      <div id="wxHint" class="text-[11px] text-slate-500 dark:text-slate-400">Tip: tap üìç to use your location for weather.</div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-screen-sm mx-auto px-3 pt-3 pb-24">
    <div id="status" class="mb-2 rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/70 p-3 text-xs text-slate-600 dark:text-slate-400">Loading‚Ä¶</div>
    <div id="panel" class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/95 dark:bg-slate-900/70 shadow-card card-tint">
      <ol id="list" class="divide-y divide-slate-200 dark:divide-slate-800" aria-live="polite"></ol>
      <button id="moreBtn" class="w-full py-3 text-sm font-semibold text-indigo-700 dark:text-indigo-300">Load more</button>
    </div>
  </main>

  <!-- Bottom dock for quick actions (intuitive, thumb-friendly) -->
  <nav class="fixed bottom-0 inset-x-0 z-50 glass bg-white/90 dark:bg-slate-950/85 border-t border-slate-200 dark:border-slate-800 safe-bottom">
    <div class="max-w-screen-sm mx-auto px-6 py-2 grid grid-cols-4 text-[11px]">
      <button id="dockHome" class="flex flex-col items-center gap-1 py-1 font-semibold">üè†<span>Home</span></button>
      <button id="dockNat" class="flex flex-col items-center gap-1 py-1">üåé<span>National</span></button>
      <button id="dockLocal" class="flex flex-col items-center gap-1 py-1">üìç<span>Local</span></button>
      <button id="dockAI" class="flex flex-col items-center gap-1 py-1">ü§ñ<span>AI</span></button>
    </div>
  </nav>

  <!-- Reader overlay -->
  <div id="reader" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" id="readerBackdrop"></div>
    <div class="absolute inset-x-0 bottom-0 top-[8dvh] rounded-t-2xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-card flex flex-col max-w-screen-sm mx-auto">
      <div class="p-3 border-b border-slate-200 dark:border-slate-800 flex items-start justify-between gap-3">
        <div class="min-w-0">
          <h2 id="readerTitle" class="text-base font-bold leading-tight line-clamp-2"></h2>
          <div id="readerMeta" class="text-[11px] text-slate-500 dark:text-slate-400 mt-0.5"></div>
        </div>
        <div class="flex items-center gap-2">
          <a id="readerOpen" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Open</a>
          <button id="readerClose" class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Close</button>
        </div>
      </div>
      <img id="readerImg" class="m-3 rounded-xl max-h-48 object-cover hidden" alt="">
      <div id="readerBody" class="prose prose-sm dark:prose-invert max-w-none px-3 pb-3 overflow-y-auto" style="max-height: 60dvh;"></div>
    </div>
  </div>

  <script>
    // ---------------------
    // SOURCES (diverse mix)
    // ---------------------
    const FEEDS = {
      "Top": [
        "https://feeds.reuters.com/reuters/topNews",
        "https://feeds.apnews.com/apf-topnews",
        "https://feeds.bbci.co.uk/news/rss.xml",
        "https://www.npr.org/sections/news/archive.rss",
        "https://www.pbs.org/newshour/feeds/rss/headlines",
        "https://www.theguardian.com/us-news/rss",
        "https://www.aljazeera.com/xml/rss/all.xml"
      ],
      "National News": [
        "https://feeds.reuters.com/reuters/topNews",
        "https://feeds.apnews.com/apf-topnews",
        "https://www.bbc.com/news/world/us_and_canada/rss.xml",
        "https://www.npr.org/feeds/1001/rss.xml",
        "https://www.politico.com/rss/politics-news.xml",
        "https://www.axios.com/feeds/feed.rss"
      ],
      "Ohio News": [
        "https://ohiocapitaljournal.com/feed/",
        "https://www.cleveland.com/ohio/rss.xml",
        "https://www.dispatch.com/arcio/rss/category/news/?outputType=xml",
        "https://www.cincinnati.com/rss/news"
      ],
      "Columbus News": [
        "https://news.wosu.org/rss",
        "https://www.nbc4i.com/feed/",
        "https://abc6onyourside.com/rss",
        "https://www.10tv.com/feeds/rssFeed?section=news",
        "https://www.columbusunderground.com/feed/"
      ],
      "Home Lending": [
        "https://www.housingwire.com/section/mortgage/feed/",
        "https://www.mortgagenewsdaily.com/rss",
        "https://www.nationalmortgagenews.com/rss",
        "https://www.fhfa.gov/Feeds/News",
        "https://www.consumerfinance.gov/about-us/newsroom/feed/"
      ],
      "AI": [
        "https://www.technologyreview.com/feed/",
        "https://openai.com/blog/rss",
        "https://ai.googleblog.com/feeds/posts/default?alt=rss",
        "https://www.anthropic.com/news/rss.xml",
        "https://ai.facebook.com/blog/rss/",
        "https://www.theverge.com/rss/ai-artificial-intelligence/index.xml",
        "https://www.techcrunch.com/tag/artificial-intelligence/feed/",
        "https://arstechnica.com/information-technology/feed/"
      ]
    };
    const ORDER = ["Top","National News","Ohio News","Columbus News","Home Lending","AI"];

    const PAGE_SIZE = 5;
    const MAX_PER_CATEGORY = 60;
    const FETCH_TIMEOUT_MS = 12000;

    // ---------------------
    // WEATHER (¬∞F & mph)
    // ---------------------
    const WX = {
      palette(code, isDay) {
        const day = [["#dfe9f3","#ffffff"],["#fef9c3","#fde68a"],["#dbeafe","#bfdbfe"],["#e2e8f0","#cbd5e1"],["#e5e7eb","#9ca3af"],["#c7d2fe","#93c5fd"],["#e9d5ff","#c4b5fd"],["#f1f5f9","#e2e8f0"],["#fde68a","#f59e0b"],["#fff1f2","#fecdd3"]];
        const night = [["#0f172a","#1e293b"],["#0b132b","#1c2541"],["#0b1220","#1f2a44"],["#0f172a","#334155"],["#0f172a","#475569"],["#0b1220","#273f6a"],["#1d1b3a","#3b2f6b"],["#111827","#374151"],["#1f2937","#374151"],["#1f2937","#334155"]];
        const pal = isDay ? day : night;
        if ([0,1].includes(code)) return pal[1];
        if ([2,3].includes(code)) return pal[2];
        if ([45,48].includes(code)) return pal[7];
        if ([51,53,55].includes(code)) return pal[4];
        if ([56,57,61,63,65,66,67,80,81,82].includes(code)) return pal[5];
        if ([71,73,75,77,85,86].includes(code)) return pal[9];
        if ([95,96,99].includes(code)) return pal[6];
        return pal[0];
      },
      text(code) {
        if (code===0) return "Clear sky";
        if (code===1) return "Mainly clear";
        if (code===2) return "Partly cloudy";
        if (code===3) return "Overcast";
        if ([45,48].includes(code)) return "Fog";
        if ([51,53,55].includes(code)) return "Drizzle";
        if ([56,57].includes(code)) return "Freezing drizzle";
        if ([61,63,65].includes(code)) return "Rain";
        if ([66,67].includes(code)) return "Freezing rain";
        if ([71,73,75].includes(code)) return "Snowfall";
        if (code===77) return "Snow grains";
        if ([80,81,82].includes(code)) return "Rain showers";
        if ([85,86].includes(code)) return "Snow showers";
        if (code===95) return "Thunderstorm";
        if ([96,99].includes(code)) return "Thunderstorm w/ hail";
        return "Weather";
      },
      emoji(code, isDay) {
        const sun="‚òÄÔ∏è", moon="üåô", cloud="‚òÅÔ∏è", rain="üåßÔ∏è", th="‚õàÔ∏è", snow="‚ùÑÔ∏è", fog="üå´Ô∏è";
        if (code===0) return isDay?sun:moon;
        if (code===1) return isDay?sun:moon;
        if (code===2) return "‚õÖ";
        if (code===3) return cloud;
        if ([45,48].includes(code)) return fog;
        if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return rain;
        if ([71,73,75,77,85,86].includes(code)) return snow;
        if ([95,96,99].includes(code)) return th;
        return "üå§Ô∏è";
      }
    };
    function hexToRgba(hex, a) {
      const h = hex.replace('#','');
      const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
    function setDynamicBackground(code, isDay) {
      const [c1, c2] = WX.palette(code, !!isDay);
      document.body.style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
      document.documentElement.style.setProperty('--tintA', `${hexToRgba(c1, 0.10)}`);
      document.documentElement.style.setProperty('--tintB', `${hexToRgba(c2, 0.10)}`);
    }

    const wxCard = document.getElementById('wxCard');
    const wxPlace = document.getElementById('wxPlace');
    const wxDesc = document.getElementById('wxDesc');
    const wxTemp = document.getElementById('wxTemp');
    const wxMeta = document.getElementById('wxMeta');
    const wxHint = document.getElementById('wxHint');
    const wxStrip = document.getElementById('wxStrip');
    const wxRow = document.getElementById('wxRow');

    async function fetchJSON(url) {
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), 12000);
      try { const r = await fetch(url, {signal: ctrl.signal}); if (!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
      finally { clearTimeout(id); }
    }
    async function reverseGeocode(lat, lon) {
      try {
        const j = await fetchJSON(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`);
        const p = j?.results?.[0];
        if (!p) return `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
        const parts = [p.name, p.admin1, p.country].filter(Boolean);
        return parts.join(", ");
      } catch { return `${lat.toFixed(2)}, ${lon.toFixed(2)}`; }
    }
    function chip(prob) {
      if (prob >= 70) return "bg-sky-600 text-white";
      if (prob >= 40) return "bg-sky-300 text-slate-800";
      if (prob > 0) return "bg-sky-100 text-slate-800";
      return "bg-slate-100 text-slate-600";
    }
    async function loadWeather(lat, lon) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation_probability,weathercode,is_day&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=auto`;
        const j = await fetchJSON(url);
        const cur = j.current_weather;
        const place = await reverseGeocode(lat, lon);
        const code = cur.weathercode ?? 2;
        const isDay = cur.is_day ?? 1;
        const emoji = WX.emoji(code, isDay);
        wxPlace.textContent = place;
        wxDesc.textContent = `${emoji} ${WX.text(code)} ¬∑ Wind ${Math.round(cur.windspeed)} mph`;
        wxTemp.textContent = `${Math.round(cur.temperature)}¬∞F`;
        wxMeta.textContent = `As of ${new Date().toLocaleTimeString()}`;
        wxCard.classList.remove("hidden");
        wxHint.classList.add("hidden");
        setDynamicBackground(code, isDay);

        // Next 12 hours mini-forecast
        const hours = j.hourly.time;
        const temps = j.hourly.temperature_2m;
        const probs = j.hourly.precipitation_probability || [];
        const wxcodes = j.hourly.weathercode || [];
        const isdayArr = j.hourly.is_day || [];
        const now = Date.now();
        wxRow.innerHTML = "";
        let added = 0;
        for (let i=0;i<hours.length && added<12;i++) {
          const ts = new Date(hours[i]).getTime();
          if (ts >= now) {
            const el = document.createElement('div');
            const prob = probs[i] ?? 0;
            const codeH = wxcodes[i] ?? code;
            const dayH = isdayArr[i] ?? isDay;
            el.className = `min-w-[56px] rounded-lg p-2 flex flex-col items-center justify-center border border-slate-200 dark:border-slate-700 ${chip(prob)}`;
            el.innerHTML = `
              <div class="text-[11px] opacity-80">${new Date(ts).toLocaleTimeString([], {hour:'numeric'})}</div>
              <div class="text-base font-bold leading-tight">${Math.round(temps[i])}¬∞</div>
              <div class="text-[14px]">${WX.emoji(codeH, dayH)}</div>
              <div class="text-[10px] opacity-80">${prob||0}%</div>`;
            wxRow.appendChild(el);
            added++;
          }
        }
        wxStrip.classList.remove("hidden");
        localStorage.setItem("wx", JSON.stringify({lat, lon, cur, place, t: Date.now()}));
      } catch {
        wxDesc.textContent = "Weather unavailable right now.";
        wxCard.classList.remove("hidden");
      }
    }
    function getLocationAndLoad() {
      if (!navigator.geolocation) { wxHint.textContent = "Geolocation not supported."; return; }
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude: lat, longitude: lon } = pos.coords || {};
        if (typeof lat === "number" && typeof lon === "number") await loadWeather(lat, lon);
      }, () => { wxHint.textContent = "Location denied. Enable permissions and tap üìç again."; }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
    }
    document.getElementById('locBtn').addEventListener('click', getLocationAndLoad);

    // ---------------------
    // THEME
    // ---------------------
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedTheme = localStorage.getItem('theme');
    if ((storedTheme === 'dark') || (!storedTheme && prefersDark)) document.documentElement.classList.add('dark');
    document.getElementById('themeBtn').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    // ---------------------
    // NEWS
    // ---------------------
    const rss2json = (u) => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(u)}`;
    function cleanHtml(html) { return (html||"").replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi,"").replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/\\s+/g," ").trim(); }
    function makeSummary(text, maxChars=600) {
      const t = cleanHtml(text);
      const sentences = t.split(/(?<=[.!?])\\s+/).filter(Boolean);
      let out = "";
      for (const s of sentences) { if ((out + (out? " ":"") + s).length <= maxChars) out += (out? " ":"") + s; else break; }
      if (!out) out = t.slice(0, maxChars);
      return out;
    }
    function timeAgo(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      const s = Math.floor((Date.now() - d.getTime()) / 1000);
      const pairs = [["yr",31536000],["mo",2592000],["d",86400],["h",3600],["m",60],["s",1]];
      for (const [n,sec] of pairs) { const v = Math.floor(s/sec); if (v>=1) return `${v}${n}`; }
      return "now";
    }
    function guessThumb(x) {
      const link = x.link || "";
      const domain = (()=>{ try { return new URL(link).origin; } catch { return ""; } })();
      const fromField = x.thumbnail || x.enclosure?.link || x.enclosure?.url || x.enclosure?.thumbnail || x.enclosure;
      if (fromField && typeof fromField === "string") return fromField;
      if (x.description) {
        const m = x.description.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (m && m[1]) return m[1];
      }
      if (domain) return `https://www.google.com/s2/favicons?sz=128&domain_url=${encodeURIComponent(domain)}`;
      return "";
    }
    function dedupe(items) {
      const seen = new Set();
      const out = [];
      for (const it of items) {
        const key = (it.title||"").trim().toLowerCase() + "|" + (it.link||"");
        if (!seen.has(key)) { seen.add(key); out.push(it); }
      }
      return out;
    }
    async function fetchWithTimeout(url) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), FETCH_TIMEOUT_MS);
      try { return await fetch(url, { signal: ctrl.signal }); }
      finally { clearTimeout(id); }
    }
    async function loadFeed(url, retries=2) {
      try {
        const r = await fetchWithTimeout(rss2json(url));
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        return (j.items||[]).map(x => ({
          title: x.title,
          link: x.link,
          desc: x.description || x.content || x.content_html || "",
          pubDate: x.pubDate || x.pub_date || x.date || x.published,
          source: j.feed?.title || (new URL(url)).hostname,
          thumb: guessThumb(x)
        }));
      } catch (e) {
        if (retries > 0) { await new Promise(res => setTimeout(res, 1200)); return loadFeed(url, retries-1); }
        return [];
      }
    }

    // State
    let currentCat = ORDER[0];
    let mode = "summaries";
    let rendered = 0; // how many list items are rendered
    let dataByCategory = {};
    let filterQ = "";

    const chips = document.getElementById('chips');
    const list = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const moreBtn = document.getElementById('moreBtn');
    const modeSel = document.getElementById('modeSel');
    const filterBox = document.getElementById('filterBox');

    function renderChips() {
      chips.innerHTML = "";
      ORDER.forEach(cat => {
        const b = document.createElement('button');
        b.className = "chip px-3 py-1.5 rounded-full border text-xs " + (cat===currentCat ? "bg-slate-900 text-white dark:bg-white dark:text-slate-900 border-slate-900 dark:border-white" : "bg-white/70 dark:bg-slate-900/40 border-slate-300 dark:border-slate-700");
        b.textContent = cat.replace(" News","");
        b.addEventListener('click', () => { currentCat = cat; rendered = 0; renderList(true); });
        chips.appendChild(b);
      });
    }

    function rowView(it) {
      const li = document.createElement('li');
      li.className = "p-3 sm:p-4";
      const sText = makeSummary(it.desc || "", 600);
      const showSummary = mode !== 'headlines' && sText.length > 0;
      const clamped = mode==='summaries';
      li.innerHTML = `
        <div class="flex items-start gap-3">
          <img class="thumb flex-none ${!it.thumb ? 'hidden':''}" src="${it.thumb || ''}" alt="" loading="lazy" onerror="this.style.display='none'">
          <div class="min-w-0 w-full">
            <div class="text-[15px] font-semibold leading-tight line-clamp-2">${it.title}</div>
            <div class="text-[11px] text-slate-500 dark:text-slate-400 mt-0.5">${it.source || ""}${it.pubDate ? " ¬∑ " + timeAgo(it.pubDate) : ""}</div>
            ${showSummary ? `<div class="text-[13px] text-slate-700 dark:text-slate-300 mt-1 ${clamped?'line-clamp-5':''}">${sText}</div>` : ""}
            <div class="mt-1 flex gap-3">
              <a class="text-[12px] text-indigo-600 dark:text-indigo-400 underline" href="${it.link}" target="_blank" rel="noopener">Open</a>
              <button class="text-[12px] text-indigo-600 dark:text-indigo-400 underline" data-action="reader">Read here</button>
            </div>
          </div>
        </div>`;
      li.querySelector('[data-action="reader"]').addEventListener('click', () => openReader(it));
      return li;
    }

    function getFiltered(cat) {
      const all = dataByCategory[cat] || [];
      if (!filterQ) return all;
      const q = filterQ.toLowerCase();
      return all.filter(it => (it.title + " " + (it.source||"") + " " + cleanHtml(it.desc||"")).toLowerCase().includes(q));
    }

    function renderList(reset=false) {
      renderChips();
      const items = getFiltered(currentCat);
      if (reset) list.innerHTML = "";
      const remaining = items.slice(rendered, rendered + PAGE_SIZE);
      remaining.forEach(it => list.appendChild(rowView(it)));
      rendered += remaining.length;
      moreBtn.classList.toggle('hidden', rendered >= items.length);
      statusEl.textContent = `${currentCat} ‚Äî ${items.length} items ¬∑ Mode: ${mode}`;
    }

    async function loadCategory(cat) {
      const feeds = FEEDS[cat] || [];
      const results = await Promise.allSettled(feeds.map(loadFeed));
      let merged = [];
      for (const r of results) if (r.status === "fulfilled") merged = merged.concat(r.value);
      merged = dedupe(merged).sort((a,b)=>new Date(b.pubDate||0)-new Date(a.pubDate||0)).slice(0,MAX_PER_CATEGORY);
      dataByCategory[cat] = merged;
      if (cat === currentCat) { rendered = 0; renderList(true); }
    }

    async function loadAll() {
      for (const cat of ORDER) await loadCategory(cat);
      document.title = `Morning News ‚Äî ${new Date().toLocaleTimeString()}`;
    }

    // Reader
    const reader = document.getElementById('reader');
    const readerBackdrop = document.getElementById('readerBackdrop');
    const readerTitle = document.getElementById('readerTitle');
    const readerMeta = document.getElementById('readerMeta');
    const readerImg = document.getElementById('readerImg');
    const readerBody = document.getElementById('readerBody');
    const readerOpen = document.getElementById('readerOpen');
    const readerClose = document.getElementById('readerClose');
    function openReader(it) {
      modeSel.value = 'reader'; mode = 'reader';
      readerTitle.textContent = it.title || "";
      readerMeta.textContent = `${it.source || ""}${it.pubDate ? " ¬∑ " + timeAgo(it.pubDate) : ""}`;
      if (it.thumb) { readerImg.src = it.thumb; readerImg.classList.remove('hidden'); } else readerImg.classList.add('hidden');
      readerBody.textContent = cleanHtml(it.desc || "") || "This source doesn't include full text in RSS. Tap Open to read more.";
      readerOpen.href = it.link || "#";
      reader.classList.remove('hidden');
    }
    readerBackdrop.addEventListener('click', () => reader.classList.add('hidden'));
    readerClose.addEventListener('click', () => reader.classList.add('hidden'));

    // Interactions
    moreBtn.addEventListener('click', () => renderList(false));
    document.getElementById('refreshBtn').addEventListener('click', loadAll);
    document.getElementById('dockHome').addEventListener('click', () => { currentCat = "Top"; rendered = 0; renderList(true); window.scrollTo({top:0,behavior:'smooth'}); });
    document.getElementById('dockNat').addEventListener('click', () => { currentCat = "National News"; rendered = 0; renderList(true); window.scrollTo({top:0,behavior:'smooth'}); });
    document.getElementById('dockLocal').addEventListener('click', () => { currentCat = "Columbus News"; rendered = 0; renderList(true); window.scrollTo({top:0,behavior:'smooth'}); });
    document.getElementById('dockAI').addEventListener('click', () => { currentCat = "AI"; rendered = 0; renderList(true); window.scrollTo({top:0,behavior:'smooth'}); });
    modeSel.addEventListener('change', () => { 
      mode = modeSel.value; 
      if (mode !== 'reader') reader.classList.add('hidden');
      rendered = 0; renderList(true);
    });

    // Debounced search
    let t;
    filterBox.addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(() => { filterQ = filterBox.value || ""; rendered = 0; renderList(true); }, 180);
    });

    // Boot
    (function init(){
      renderChips();
      renderList(true);
      loadAll();
      // Weather cached or fresh
      try {
        const cached = JSON.parse(localStorage.getItem("wx")||"null");
        if (cached && Date.now() - cached.t < 30*60*1000) {
          const {cur, place} = cached;
          const code = cur.weathercode ?? 2;
          const isDay = cur.is_day ?? 1;
          wxPlace.textContent = place;
          wxDesc.textContent = `${WX.emoji(code,isDay)} ${WX.text(code)} ¬∑ Wind ${Math.round(cur.windspeed)} mph`;
          wxTemp.textContent = `${Math.round(cur.temperature)}¬∞F`;
          wxMeta.textContent = `Cached ¬∑ ${new Date(cached.t).toLocaleTimeString()}`;
          wxCard.classList.remove("hidden");
          setDynamicBackground(code, isDay);
        }
      } catch {}
      // Try locate on boot (silent; user can tap üìç anytime)
      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({name:'geolocation'}).then(p => { if (p.state === 'granted') getLocationAndLoad(); });
      } else { getLocationAndLoad(); }
    })();
  </script>
</body>
</html>
