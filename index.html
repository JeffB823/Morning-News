<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Jeff's News </title>
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Helvetica','Arial'] } } }, darkMode: 'class' }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    .thumb{width:60px;height:60px;object-fit:cover;border-radius:12px;background:#e2e8f0}
    @media (prefers-color-scheme:dark){.thumb{background:#0b1220}}
    .line-5{display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}
    .glass{backdrop-filter:saturate(140%) blur(8px)}
    .no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    body{transition:background .6s cubic-bezier(.2,.8,.2,1);background-attachment:fixed}
  </style>
</head>
<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100">
<header class="sticky top-0 z-40 glass bg-white/85 dark:bg-slate-950/80 border-b border-slate-200 dark:border-slate-800">
  <div class="max-w-screen-sm mx-auto px-3 py-2 flex items-center justify-between gap-2">
    <div class="flex items-center gap-2">
      <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-indigo-500 to-sky-500"></div>
      <div>
        <h1 class="text-base font-extrabold">Morning News</h1>
        <p class="text-[11px] text-slate-500 dark:text-slate-400">Hardened loader ¬∑ Mobile-first</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="themeBtn" class="px-2.5 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Theme</button>
      <button id="refreshBtn" class="px-2.5 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Refresh</button>
    </div>
  </div>

  <div class="max-w-screen-sm mx-auto px-3 pb-2 flex items-stretch gap-2">
    <input id="q" type="search" placeholder="Search‚Ä¶" class="flex-1 px-3 py-2 text-sm rounded-xl border border-slate-300 dark:border-slate-700 bg-white/90 dark:bg-slate-900/70 outline-none">
    <button id="locBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-xs">üìç</button>
    <select id="modeSel" class="px-2 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-xs">
      <option value="headlines">Headlines</option>
      <option value="summaries" selected>Summaries</option>
      <option value="reader">Reader</option>
    </select>
  </div>

  <div class="max-w-screen-sm mx-auto px-3 pb-2 overflow-x-auto no-scrollbar">
    <div id="chips" class="flex gap-2"></div>
  </div>

  <div class="max-w-screen-sm mx-auto px-3 pb-3 space-y-2">
    <div id="wxCard" class="hidden rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/70 p-3 text-sm flex items-center justify-between">
      <div class="min-w-0">
        <div id="wxPlace" class="font-semibold truncate">‚Äî</div>
        <div id="wxDesc" class="text-xs text-slate-600 dark:text-slate-400 truncate">‚Äî</div>
      </div>
      <div class="text-right">
        <div id="wxTemp" class="text-lg font-bold">‚Äî¬∞F</div>
        <div id="wxMeta" class="text-[11px] text-slate-500 dark:text-slate-400">‚Äî</div>
      </div>
    </div>
    <div id="wxHint" class="text-[11px] text-slate-500 dark:text-slate-400">Weather: tap üìç and allow location.</div>
  </div>
</header>

<main class="max-w-screen-sm mx-auto px-3 pt-3 pb-24">
  <div id="status" class="mb-2 rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/70 p-3 text-xs text-slate-600 dark:text-slate-400">Loading‚Ä¶</div>
  <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/95 dark:bg-slate-900/70">
    <ol id="list" class="divide-y divide-slate-200 dark:divide-slate-800" aria-live="polite"></ol>
    <button id="moreBtn" class="w-full py-3 text-sm font-semibold text-indigo-700 dark:text-indigo-300">Load more</button>
  </div>
</main>

<!-- Reader -->
<div id="reader" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40" id="readerBackdrop"></div>
  <div class="absolute inset-x-0 bottom-0 top-[8dvh] rounded-t-2xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-card flex flex-col max-w-screen-sm mx-auto">
    <div class="p-3 border-b border-slate-200 dark:border-slate-800 flex items-start justify-between gap-3">
      <div class="min-w-0">
        <h2 id="readerTitle" class="text-base font-bold leading-tight"></h2>
        <div id="readerMeta" class="text-[11px] text-slate-500 dark:text-slate-400 mt-0.5"></div>
      </div>
      <div class="flex items-center gap-2">
        <a id="readerOpen" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Open</a>
        <button id="readerClose" class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 text-xs">Close</button>
      </div>
    </div>
    <div id="readerBody" class="prose prose-sm dark:prose-invert max-w-none px-3 pb-3 overflow-y-auto" style="max-height:60dvh;"></div>
  </div>
</div>

<script>
const FEEDS = {
  "Top": [
    "https://feeds.reuters.com/reuters/topNews",
    "https://feeds.apnews.com/apf-topnews",
    "https://feeds.bbci.co.uk/news/rss.xml",
    "https://www.npr.org/sections/news/archive.rss",
    "https://www.pbs.org/newshour/feeds/rss/headlines",
    "https://www.theguardian.com/us-news/rss"
  ],
  "Ohio": [
    "https://ohiocapitaljournal.com/feed/",
    "https://www.cleveland.com/ohio/rss.xml",
    "https://www.dispatch.com/arcio/rss/category/news/?outputType=xml",
    "https://www.cincinnati.com/rss/news"
  ],
  "Columbus": [
    "https://news.wosu.org/rss",
    "https://www.nbc4i.com/feed/",
    "https://abc6onyourside.com/rss",
    "https://www.10tv.com/feeds/rssFeed?section=news",
    "https://www.columbusunderground.com/feed/"
  ],
  "Home Lending": [
    "https://www.housingwire.com/section/mortgage/feed/",
    "https://www.mortgagenewsdaily.com/rss",
    "https://www.nationalmortgagenews.com/rss",
    "https://www.fhfa.gov/Feeds/News"
  ],
  "AI": [
    "https://www.technologyreview.com/feed/",
    "https://openai.com/blog/rss",
    "https://ai.googleblog.com/feeds/posts/default?alt=rss",
    "https://www.theverge.com/rss/ai-artificial-intelligence/index.xml",
    "https://arstechnica.com/information-technology/feed/"
  ]
};
const ORDER = Object.keys(FEEDS);
const PAGE_SIZE = 5;
const TIMEOUT = 12000;

const rss2json = (u) => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(u)}`;
const allorigins = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`;
const corsgit    = (u) => `https://cors.isomorphic-git.org/${u}`;

function log(){ try { console.log.apply(console, arguments); } catch(e){} }

function cleanHtml(html){ return (html||"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(); }
function summarize(html, max=600){
  const t = cleanHtml(html);
  const parts = t.split(/(?<=[.!?])\s+/).filter(Boolean);
  let out=""; for (const s of parts) { if ((out+(out?" ":"")+s).length<=max) out+=(out?" ":"")+s; else break; }
  return out || t.slice(0,max);
}
function timeAgo(s){ const d=new Date(s); if(isNaN(d)) return ""; const sec=Math.floor((Date.now()-d)/1000); const pairs=[["yr",31536000],["mo",2592000],["d",86400],["h",3600],["m",60],["s",1]]; for(const [n,v] of pairs){ const k=Math.floor(sec/v); if(k>=1) return k+n; } return "now"; }
function guessThumb(item){
  const link=item.link||""; let domain=""; try{domain=new URL(link).origin;}catch{}
  const f=item.thumbnail || item.enclosure?.url || item.enclosure?.link || item.enclosure || "";
  if (typeof f==="string" && f) return f;
  if (item.description){ const m = item.description.match(/<img[^>]+src=["']([^"']+)["']/i); if (m && m[1]) return m[1]; }
  return domain?`https://www.google.com/s2/favicons?sz=128&domain_url=${encodeURIComponent(domain)}`:"";
}

function withTimeout(promise, ms=TIMEOUT){ const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(),ms); return fetch(promise, {signal: ctrl.signal}).finally(()=>clearTimeout(t)); }

async function fetchText(url){
  const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(), TIMEOUT);
  try{ const r=await fetch(url,{signal:ctrl.signal}); if(!r.ok) throw new Error("HTTP "+r.status); return await r.text(); }
  finally{ clearTimeout(id); }
}

async function loadFeedJson(url){
  const r=await fetch(rss2json(url));
  if(!r.ok) throw new Error("rss2json "+r.status);
  const j=await r.json();
  return (j.items||[]).map(x=>({title:x.title, link:x.link, description:x.description||x.content||x.content_html||"", pubDate:x.pubDate||x.pub_date||x.date||x.published, source:j.feed?.title||(new URL(url)).hostname, thumb:guessThumb(x)}));
}
async function loadFeedXml(url, proxy){
  const txt = await fetchText(proxy(url));
  const doc = new DOMParser().parseFromString(txt, "application/xml");
  const nodes = Array.from(doc.querySelectorAll("item,entry"));
  return nodes.map(n=>{
    const g = sel => n.querySelector(sel)?.textContent || "";
    const linkNode = n.querySelector("link");
    let link = g("link");
    if (linkNode && linkNode.getAttribute("href")) link = linkNode.getAttribute("href");
    const enclosure = n.querySelector("enclosure");
    const thumb = enclosure?.getAttribute("url") || "";
    return { title:g("title"), link, description:g("description")||g("content")||g("summary"), pubDate:g("pubDate")||g("updated")||g("published"), source: (doc.querySelector("channel>title")?.textContent) || (new URL(url)).hostname, thumb };
  });
}
async function loadFeed(url){
  // try JSON API, then AllOrigins XML, then cors.isomorphic-git XML
  try { return await loadFeedJson(url); }
  catch(e1){ log("rss2json failed", url, e1); try { return await loadFeedXml(url, allorigins); }
  catch(e2){ log("allorigins failed", url, e2); try { return await loadFeedXml(url, corsgit); }
  catch(e3){ log("corsgit failed", url, e3); return []; }}}
}

function dedupe(arr){
  const seen=new Set(); const out=[];
  for(const it of arr){ const key=(it.title||"")+"|"+(it.link||""); if(!seen.has(key)){ seen.add(key); out.push(it);} }
  return out;
}

// UI state
let current = ORDER[0], mode="summaries", rendered=0, dataByCat = {}, q="";
const list = document.getElementById('list');
const statusEl = document.getElementById('status');
const moreBtn = document.getElementById('moreBtn');
const chips = document.getElementById('chips');
const modeSel = document.getElementById('modeSel');
const qBox = document.getElementById('q');

function renderChips(){
  chips.innerHTML="";
  ORDER.forEach(cat=>{
    const b=document.createElement('button');
    b.className="px-3 py-1.5 rounded-full border text-xs "+(cat===current?"bg-slate-900 text-white dark:bg-white dark:text-slate-900 border-slate-900 dark:border-white":"bg-white/70 dark:bg-slate-900/40 border-slate-300 dark:border-slate-700");
    b.textContent = cat;
    b.addEventListener('click', ()=>{ current=cat; rendered=0; renderList(true); });
    chips.appendChild(b);
  });
}

function rowView(it){
  const li = document.createElement('li');
  const sum = summarize(it.description||"", 600);
  const showSum = mode!=='headlines' && sum;
  li.className="p-3";
  li.innerHTML = `<div class="flex items-start gap-3">
    <img class="thumb ${!it.thumb?'hidden':''}" src="${it.thumb||''}" onerror="this.style.display='none'">
    <div class="min-w-0 w-full">
      <div class="text-[15px] font-semibold leading-tight">${it.title||''}</div>
      <div class="text-[11px] text-slate-500 dark:text-slate-400">${it.source||''}${it.pubDate?' ¬∑ '+timeAgo(it.pubDate):''}</div>
      ${ showSum ? `<div class="text-[13px] text-slate-700 dark:text-slate-300 mt-1 line-5">${sum}</div>`:''}
      <div class="mt-1 flex gap-3">
        <a class="text-[12px] text-indigo-600 dark:text-indigo-400 underline" href="${it.link}" target="_blank" rel="noopener">Open</a>
        <button class="text-[12px] text-indigo-600 dark:text-indigo-400 underline" data-r="1">Read here</button>
      </div>
    </div>
  </div>`;
  li.querySelector('[data-r]').addEventListener('click', ()=>openReader(it));
  return li;
}

function getFiltered(cat){
  const all = dataByCat[cat] || [];
  if (!q) return all;
  const L = q.toLowerCase();
  return all.filter(it => ((it.title||"") + " " + (it.source||"") + " " + cleanHtml(it.description||"")).toLowerCase().includes(L));
}

function renderList(reset){
  renderChips();
  const items = getFiltered(current);
  if (reset) list.innerHTML="";
  const batch = items.slice(rendered, rendered+PAGE_SIZE);
  batch.forEach(it => list.appendChild(rowView(it)));
  rendered += batch.length;
  moreBtn.classList.toggle('hidden', rendered >= items.length);
  statusEl.textContent = `${current} ‚Äî ${items.length} items ¬∑ Mode: ${mode}`;
}

async function loadCategory(cat){
  statusEl.textContent = `Loading ${cat}‚Ä¶`;
  const feeds = FEEDS[cat] || [];
  const results = await Promise.allSettled(feeds.map(loadFeed));
  let merged=[];
  for (const r of results) if (r.status==="fulfilled") merged=merged.concat(r.value);
  merged = dedupe(merged).sort((a,b)=>new Date(b.pubDate||0)-new Date(a.pubDate||0)).slice(0,60);
  dataByCat[cat]=merged;
  if (cat===current){ rendered=0; renderList(true); }
}

async function loadAll(){
  for (const cat of ORDER) await loadCategory(cat);
  statusEl.textContent = "Done.";
}

// Reader
const reader = document.getElementById('reader');
const readerBackdrop = document.getElementById('readerBackdrop');
const readerTitle = document.getElementById('readerTitle');
const readerMeta = document.getElementById('readerMeta');
const readerBody = document.getElementById('readerBody');
const readerOpen = document.getElementById('readerOpen');
const readerClose = document.getElementById('readerClose');
function openReader(it){
  modeSel.value='reader'; mode='reader';
  readerTitle.textContent = it.title||"";
  readerMeta.textContent = (it.source||"") + (it.pubDate ? " ¬∑ " + timeAgo(it.pubDate) : "");
  readerBody.textContent = cleanHtml(it.description||"") || "This source didn't include full text. Tap Open to read more.";
  readerOpen.href = it.link||"#";
  reader.classList.remove('hidden');
}
readerBackdrop.addEventListener('click', ()=>reader.classList.add('hidden'));
readerClose.addEventListener('click', ()=>reader.classList.add('hidden'));

// Theme
const themeBtn = document.getElementById('themeBtn');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
const storedTheme = localStorage.getItem('theme');
if ((storedTheme==='dark') || (!storedTheme && prefersDark)) document.documentElement.classList.add('dark');
themeBtn.addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light'); });

// Weather
const wxCard = document.getElementById('wxCard'), wxPlace = document.getElementById('wxPlace'), wxDesc=document.getElementById('wxDesc'), wxTemp=document.getElementById('wxTemp'), wxMeta=document.getElementById('wxMeta'), wxHint=document.getElementById('wxHint');
async function jget(url){ const r=await fetch(url); if(!r.ok) throw new Error(r.status); return r.json(); }
function bg(code,isDay){ const d=[["#dfe9f3","#fff"],["#fef9c3","#fde68a"],["#dbeafe","#bfdbfe"],["#e2e8f0","#cbd5e1"],["#e5e7eb","#9ca3af"],["#c7d2fe","#93c5fd"],["#e9d5ff","#c4b5fd"],["#f1f5f9","#e2e8f0"]]; const n=[["#0f172a","#1e293b"],["#0b132b","#1c2541"],["#0b1220","#1f2a44"],["#0f172a","#334155"]]; return (isDay?d:n)[2]; }
function wtxt(code){ if(code===0) return "Clear sky"; if(code===1) return "Mainly clear"; if(code===2) return "Partly cloudy"; if(code===3) return "Overcast"; if([45,48].includes(code)) return "Fog"; if([51,53,55].includes(code)) return "Drizzle"; if([61,63,65].includes(code)) return "Rain"; if([80,81,82].includes(code)) return "Showers"; if([71,73,75].includes(code)) return "Snow"; if([95,96,99].includes(code)) return "Thunderstorm"; return "Weather"; }
async function loadWeather(lat,lon){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=auto`;
    const j=await jget(url);
    const cur=j.current_weather; const code=cur.weathercode??2, isDay=cur.is_day??1;
    wxPlace.textContent = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
    // reverse geocode
    try{ const g=await jget(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`); const p=g?.results?.[0]; if(p){ wxPlace.textContent=[p.name,p.admin1,p.country].filter(Boolean).join(", "); } }catch{}
    wxDesc.textContent = `${wtxt(code)} ¬∑ Wind ${Math.round(cur.windspeed)} mph`;
    wxTemp.textContent = `${Math.round(cur.temperature)}¬∞F`;
    wxMeta.textContent = `As of ${new Date().toLocaleTimeString()}`;
    wxCard.classList.remove('hidden'); wxHint.classList.add('hidden');
    const [c1,c2]=bg(code,isDay); document.body.style.background=`linear-gradient(135deg, ${c1}, ${c2})`;
    localStorage.setItem("wx", JSON.stringify({lat,lon,cur,t:Date.now()}));
  }catch(e){ wxDesc.textContent="Weather unavailable. Tap üìç to retry."; wxCard.classList.remove('hidden'); }
}
function askGeo(){
  if (!navigator.geolocation){ wxHint.textContent="Geolocation not supported."; return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const {latitude:lat, longitude:lon} = pos.coords || {};
    if (typeof lat==="number" && typeof lon==="number") loadWeather(lat,lon);
  }, err => {
    wxHint.textContent = "Location blocked. Tap üìç again and allow. (Check site settings.)";
  }, {enableHighAccuracy:true, timeout:10000, maximumAge:60000});
}
document.getElementById('locBtn').addEventListener('click', askGeo);

// Search & controls
let timer;
qBox.addEventListener('input', ()=>{ clearTimeout(timer); timer=setTimeout(()=>{ q=qBox.value||""; rendered=0; renderList(true); }, 180); });
modeSel.addEventListener('change', ()=>{ mode=modeSel.value; if(mode!=='reader') reader.classList.add('hidden'); rendered=0; renderList(true); });
moreBtn.addEventListener('click', ()=>renderList(false));
document.getElementById('refreshBtn').addEventListener('click', ()=>loadAll());

(function init(){
  // restore cached weather fast
  try{ const c=JSON.parse(localStorage.getItem("wx")||"null"); if(c && Date.now()-c.t<30*60*1000){ const {cur,lat,lon}=c; wxPlace.textContent=`${lat.toFixed(2)}, ${lon.toFixed(2)}`; wxDesc.textContent=`${wtxt(cur.weathercode)} ¬∑ Wind ${Math.round(cur.windspeed)} mph`; wxTemp.textContent=`${Math.round(cur.temperature)}¬∞F`; wxMeta.textContent=`Cached ¬∑ ${new Date(c.t).toLocaleTimeString()}`; wxCard.classList.remove('hidden'); } }catch{}
  // auto-ask for geo; some browsers need a user gesture, so we also show big üìç button
  askGeo();
  renderChips();
  renderList(true);
  loadAll();
})();
</script>
</body>
</html>
